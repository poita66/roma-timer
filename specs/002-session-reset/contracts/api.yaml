openapi: 3.0.3
info:
  title: Roma Timer API - Daily Session Reset
  description: API endpoints for the Daily Session Reset feature
  version: 1.0.0
  contact:
    name: Roma Timer Development Team

servers:
  - url: http://localhost:8080/api
    description: Development server

paths:
  # Session Management Endpoints
  /session/count:
    get:
      summary: Get current session count
      description: Returns the current session count and next reset time
      tags:
        - Session Management
      responses:
        '200':
          description: Session count retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionCountResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

    put:
      summary: Set session count manually
      description: Manually override the session count with validation
      tags:
        - Session Management
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SetSessionCountRequest'
      responses:
        '200':
          description: Session count updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionCountResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /session/reset:
    post:
      summary: Manually reset session count
      description: Immediately reset session count to 0 and log the event
      tags:
        - Session Management
      responses:
        '200':
          description: Session reset completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionResetResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  # Daily Reset Configuration Endpoints
  /configuration/daily-reset:
    get:
      summary: Get daily reset configuration
      description: Returns current daily reset settings
      tags:
        - Configuration
      responses:
        '200':
          description: Daily reset configuration retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DailyResetConfigResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

    put:
      summary: Update daily reset configuration
      description: Configure daily reset time and settings
      tags:
        - Configuration
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateDailyResetRequest'
      responses:
        '200':
          description: Daily reset configuration updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DailyResetConfigResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /configuration/timezone:
    put:
      summary: Update user timezone
      description: Change user timezone and reschedule daily reset
      tags:
        - Configuration
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateTimezoneRequest'
      responses:
        '200':
          description: Timezone updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TimezoneUpdateResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  # Analytics and Statistics Endpoints
  /analytics/daily-stats:
    get:
      summary: Get daily session statistics
      description: Retrieve daily session statistics for a date range
      tags:
        - Analytics
      parameters:
        - name: start_date
          in: query
          description: Start date in YYYY-MM-DD format (UTC)
          required: true
          schema:
            type: string
            format: date
        - name: end_date
          in: query
          description: End date in YYYY-MM-DD format (UTC)
          required: true
          schema:
            type: string
            format: date
        - name: timezone
          in: query
          description: Timezone for display (optional, defaults to user's timezone)
          required: false
          schema:
            type: string
      responses:
        '200':
          description: Daily statistics retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DailyStatsResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  # Session Reset Events Endpoints
  /session/reset-events:
    get:
      summary: Get session reset events
      description: Retrieve recent session reset events for debugging
      tags:
        - Analytics
      parameters:
        - name: limit
          in: query
          description: Maximum number of events to return (default: 50, max: 200)
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 50
        - name: start_date
          in: query
          description: Start date for filtering (YYYY-MM-DD format)
          required: false
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Reset events retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResetEventsResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

components:
  schemas:
    # Base Schemas
    BaseResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Operation completed successfully"
        timestamp:
          type: string
          format: date-time
          example: "2025-01-07T10:30:00Z"

    ErrorResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          properties:
            success:
              type: boolean
              example: false
            error_code:
              type: string
              example: "VALIDATION_ERROR"
            details:
              type: object
              additionalProperties: true

    # Daily Reset Configuration Schemas
    DailyResetTime:
      type: object
      oneOf:
        - type: object
          properties:
            type:
              type: string
              enum: [midnight]
              example: "midnight"
        - type: object
          properties:
            type:
              type: string
              enum: [hour]
            hour:
              type: integer
              minimum: 0
              maximum: 23
              example: 7
        - type: object
          properties:
            type:
              type: string
              enum: [custom]
            time:
              type: string
              pattern: "^([01]?[0-9]|2[0-3]):[0-5][0-9]$"
              example: "07:30"
      discriminator:
        propertyName: type

    DailyResetConfig:
      type: object
      properties:
        enabled:
          type: boolean
          description: Whether daily reset is enabled
          example: true
        reset_time:
          $ref: '#/components/schemas/DailyResetTime'
        timezone:
          type: string
          description: User's timezone (IANA identifier)
          example: "America/New_York"
        next_reset_utc:
          type: string
          format: date-time
          description: Next scheduled reset time in UTC
          example: "2025-01-08T12:00:00Z"
        next_reset_local:
          type: string
          description: Next reset time in user's local timezone
          example: "2025-01-08 07:00"
        last_reset_utc:
          type: string
          format: date-time
          description: Last reset time in UTC
          example: "2025-01-07T12:00:00Z"
      required:
        - enabled
        - reset_time
        - timezone

    # Session Management Schemas
    SessionCountResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          properties:
            data:
              type: object
              properties:
                current_count:
                  type: integer
                  minimum: 0
                  maximum: 1000
                  example: 5
                manual_override:
                  type: integer
                  minimum: 0
                  maximum: 1000
                  nullable: true
                  example: null
                today_date:
                  type: string
                  format: date
                  example: "2025-01-07"
                next_reset_utc:
                  type: string
                  format: date-time
                  nullable: true
                  example: "2025-01-08T07:00:00Z"
                next_reset_local:
                  type: string
                  nullable: true
                  example: "2025-01-08 02:00"

    SetSessionCountRequest:
      type: object
      properties:
        count:
          type: integer
          minimum: 0
          maximum: 1000
          description: Session count to set (0-1000)
          example: 15
        clear_override:
          type: boolean
          description: Clear any existing manual override
          default: false
      required:
        - count

    SessionResetResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          properties:
            data:
              type: object
              properties:
                previous_count:
                  type: integer
                  example: 8
                new_count:
                  type: integer
                  example: 0
                reset_timestamp:
                  type: string
                  format: date-time
                  example: "2025-01-07T15:30:00Z"
                reset_type:
                  type: string
                  enum: [manual, scheduled, timezone_change, configuration_change]
                  example: "manual"

    # Configuration Request/Response Schemas
    UpdateDailyResetRequest:
      type: object
      properties:
        enabled:
          type: boolean
          example: true
        reset_time:
          $ref: '#/components/schemas/DailyResetTime'
        timezone:
          type: string
          description: User's timezone (IANA identifier)
          example: "Europe/London"
      required:
        - enabled
        - reset_time

    DailyResetConfigResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          properties:
            data:
              $ref: '#/components/schemas/DailyResetConfig'

    UpdateTimezoneRequest:
      type: object
      properties:
        timezone:
          type: string
          description: IANA timezone identifier
          example: "Asia/Tokyo"
        reschedule_reset:
          type: boolean
          description: Whether to reschedule existing daily reset
          default: true
      required:
        - timezone

    TimezoneUpdateResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          properties:
            data:
              type: object
              properties:
                old_timezone:
                  type: string
                  example: "UTC"
                new_timezone:
                  type: string
                  example: "Asia/Tokyo"
                reset_rescheduled:
                  type: boolean
                  example: true
                new_next_reset_utc:
                  type: string
                  format: date-time
                  example: "2025-01-08T15:00:00Z"
                new_next_reset_local:
                  type: string
                  example: "2025-01-08 00:00"

    # Analytics Schemas
    DailyStats:
      type: object
      properties:
        date:
          type: string
          format: date
          example: "2025-01-07"
        work_sessions_completed:
          type: integer
          minimum: 0
          example: 6
        total_work_seconds:
          type: integer
          minimum: 0
          example: 9000
        total_break_seconds:
          type: integer
          minimum: 0
          example: 1800
        manual_overrides:
          type: integer
          minimum: 0
          example: 1
        timezone:
          type: string
          example: "America/New_York"

    DailyStatsResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
        properties:
            data:
              type: object
              properties:
                statistics:
                  type: array
                  items:
                    $ref: '#/components/schemas/DailyStats'
                total_days:
                  type: integer
                  example: 7
                timezone:
                  type: string
                  description: Timezone used for the statistics
                  example: "UTC"

    # Reset Events Schemas
    SessionResetEvent:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        reset_type:
          type: string
          enum: [scheduled_daily, manual_reset, timezone_change, configuration_change]
          example: "scheduled_daily"
        previous_count:
          type: integer
          example: 5
        new_count:
          type: integer
          example: 0
        reset_timestamp:
          type: string
          format: date-time
          example: "2025-01-07T07:00:00Z"
        user_timezone:
          type: string
          example: "America/New_York"
        local_reset_time:
          type: string
          example: "2025-01-07 02:00"
        device_id:
          type: string
          nullable: true
          example: "web-client-123"
        context:
          type: object
          nullable: true
          additionalProperties: true

    ResetEventsResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
        properties:
          data:
            type: object
            properties:
              events:
                type: array
                items:
                  $ref: '#/components/schemas/SessionResetEvent'
              total_count:
                type: integer
                example: 15

  responses:
    BadRequest:
      description: Bad request - validation error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            message: "Validation failed"
            error_code: "VALIDATION_ERROR"
            details:
              field: "count"
              error: "Value must be between 0 and 1000"
            timestamp: "2025-01-07T10:30:00Z"

    Unauthorized:
      description: Unauthorized - authentication required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            message: "Authentication required"
            error_code: "UNAUTHORIZED"
            timestamp: "2025-01-07T10:30:00Z"

    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            message: "Internal server error"
            error_code: "INTERNAL_ERROR"
            timestamp: "2025-01-07T10:30:00Z"

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token for authentication

security:
  - BearerAuth: []

tags:
  - name: Session Management
    description: Operations for managing session counts and resets
  - name: Configuration
    description: Operations for configuring daily reset settings
  - name: Analytics
    description: Operations for accessing session statistics and events